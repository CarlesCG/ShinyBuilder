{
    "contents" : "#-----------\n#Static Data\n#-----------\n#HTML templates\nremove_btn      <- HTML('<button type=\"button\" class=\"close deleteme\" aria-hidden=\"true\">x</button>')\nedit_qry_btn    <- tags$div(class=\"btn\", 'data-toggle'=\"modal\", 'data-target'=\"#full-width\", 'Edit Query')\ninline_opts     <- 'inline: true, \n        plugins: [\"advlist autolink lists link image charmap print preview anchor\",\n                  \"searchreplace visualblocks code fullscreen\",\n                  \"insertdatetime media table contextmenu paste\"],\n        toolbar: \"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image\"'        \n\n\n#Default data\ndefault_db_name   <- names(db_list)[1]\ndefault_db_obj    <- db_list[[default_db_name]]\ndefault_qry       <- default_db_obj$smpl_qry\ndefault_data      <- do.call(default_db_obj$qry_fn, list(default_db_obj$db, default_qry))\ncurr_result_tbl   <- default_data\ndefault_dashboard <- 'Sample Dashboard'\n\n#-----------------------\n#Shiny Server Definition\n#-----------------------\nshinyServer(function(input, output, session) {\n\n  #Initialization constants\n  first_time            <- 1\n  update_preview_val    <- 0\n  \n  #Determine Available dashboards\n  available_dashboards  <- reactive({invalidateLater(1000*30, session); str_replace(list.files(str_c(getwd(),'/dashboards')), '.RData', '')})\n  \n  #Determine selected dashboard from url\n  selected_dashboard <- reactive({\n    url_query <- parseQueryString(session$clientData$url_search)\n    selected_dashboard <- default_dashboard\n    if (length(url_query) > 0 )\n      if(url_query[[1]] %in% isolate(available_dashboards()))\n        selected_dashboard <- url_query[[1]]\n    selected_dashboard\n  })\n  \n  #Handle dashboard switch event\n  observe({\n    if(input$sel_dashboard != selected_dashboard() & first_time == 0){\n      session$sendCustomMessage(type = \"shiny.go_to_url\", list(url = isolate(input$sel_dashboard)))\n    }\n  })\n  \n  #Handle dashboard delete event\n  observe({\n    if(input$delete_dash_btn > 0){\n      if(isolate(selected_dashboard()) != default_dashboard){\n        file.remove(str_c(getwd(), '/dashboards/', isolate(selected_dashboard()),'.RData')) \n        session$sendCustomMessage(type = \"shiny.go_to_url\", list(url = default_dashboard))\n      }\n    }\n  })\n    \n  #Available dashboards\n  observe({\n    invalidateLater(1000*30, session) #Update once every 30 sec\n    updateSelectInput(session, 'sel_dashboard', choices = available_dashboards(), selected = selected_dashboard())\n    first_time <<-0\n  })\n  \n  \n  #Initialize core data stores\n  widget_counts <- reactiveValues(num_charts = 0, num_textareas = 0)\n  input_dbs     <- reactiveValues()\n  input_queries <- reactiveValues()\n  input_data    <- reactiveValues()\n  last_update   <- reactiveValues()\n    \n  #Selected Database\n  selected_db       <- reactive({db_list[[input$selected_db]]$db})\n  selected_qry_fn   <- reactive({db_list[[input$selected_db]]$qry_fn})\n  \n  #Save Query Button\n  observe({\n    if(input$save_changes > 0){\n      isolate({\n        chart_id                  <- input$active_chart_id\n        \n        input_dbs[[chart_id]]     <- input$selected_db\n        print(input_dbs[[chart_id]])\n        input_queries[[chart_id]] <- input$code\n        input_data[[chart_id]]    <- do.call(selected_qry_fn(), list(selected_db(), input$code))\n        last_update[[chart_id]]   <- now()\n      })\n    }\n  }) \n  \n  #Current Results Table\n  curr_result_tbl <- reactive({\n    active_chart_id <- input$active_chart_id\n    if(active_chart_id != ''){\n      if(input$update_preview > update_preview_val){ \n        #If change comes from 'run query'\n        update_preview_val     <<- input$update_preview\n        return(isolate(do.call(selected_qry_fn(), list(selected_db(), input$code))))\n      }\n      else{ #If change comes from switching active tile\n        return(input_data[[active_chart_id]])\n      }\n    }else{\n      return(data.frame(i = 1))\n    }\n    \n  })\n  \n  #Result Table\n  output$output_tbl <- renderDataTable(curr_result_tbl(), options = list(iDisplayLength = 5))\n  \n  #Code Editor/Selected DB Observer\n  observe({\n    active_chart_id <- input$active_chart_id\n    if(active_chart_id != ''){\n      updateAceEditor(session, 'code', value=isolate(input_queries[[active_chart_id]]))\n      updateSelectInput(session, 'selected_db', label = NULL, choices = names(db_list), selected = input_dbs[[active_chart_id]])\n    }\n  })\n  \n  \n  #Add Chart Widget Function\n  chartWidget <- function (chart_id, chart_type, chart_opts){ \n    isolate({\n    charteditor_id <- str_c(chart_id, '_editor')\n    \n    #Query Editor Button\n    edit_qry_btn    <- tags$div(class=\"qry btn\", 'style'=\"display:inline;\", 'data-toggle'=\"modal\", 'data-target'=\"#full-width\", 'chart-id'= chart_id, title = 'Edit Query', icon('pencil-square-o'),'Query')\n    \n    #Chart\n    output[[chart_id]] <- renderGoogleChart({ \n      googleChartObject(\n        data = input_data[[chart_id]], \n        type = input[[charteditor_id]]$chartType, \n        options = input[[charteditor_id]]$options)\n    })\n    \n    #Widget content\n    widget_id   <- str_c('w_', chart_id)\n    widget_html <- paste0(tags$li(\n      class = 'new',\n      id = widget_id, \n      remove_btn, \n      edit_qry_btn, \n      googleChartEditor(charteditor_id, chart_id, chart_type, chart_opts, paste0(icon('pencil-square-o'), ' Chart ')),\n      fluidRow(googleChartOutput(chart_id), style = 'height : 100%;')\n    ))\n    })\n    return(widget_html)\n  }\n  \n  #Chart Initialization Observer\n  observe({ #Take dependence on addChart button \n    if(input$addChart > 0){\n    #Increment num charts\n    widget_counts$num_charts <- isolate(widget_counts$num_charts) + 1\n    num_charts <- isolate(widget_counts$num_charts)  \n    #print(str_c('Num charts: ', num_charts))\n    \n      chart_id                  <- str_c('gItemPlot', num_charts)\n      input_dbs[[chart_id]]     <- default_db_name\n      input_queries[[chart_id]] <- default_qry\n      input_data[[chart_id]]    <- default_data\n      \n      widget_html <- chartWidget(chart_id, 'Table', '{}')\n      dataList <- list(id = 'gridster_frame', html = widget_html)\n      dataList$size_x <- 2\n      dataList$size_y <- 1\n      session$sendCustomMessage(\"shinyGridster.add_widget\", dataList) \n    \n    }\n  })  \n  \n  #Text Area Initialization Observer\n  observe({#Take dependence on addText Button\n    if(input$addText > 0){  \n      widget_counts$num_textareas <- isolate(widget_counts$num_textareas) + 1\n      num_textareas     <- isolate(widget_counts$num_textareas)\n      #print(str_c('Num text areas: ', num_textareas))\n      \n      if(num_textareas > 0){\n        textarea_id     <- str_c('textArea', num_textareas)\n        widget_id       <- str_c('w_', textarea_id)\n        #text_area_tmpl  <- tinyMCE(textarea_id, 'Click to edit text.', inline_opts)\n        text_area_tmpl  <- tags$div(id = textarea_id, class = \"shinytinymce\", 'Click to edit text.', style = \"resize: none; width: 100%; height: 100%; border-style: none; background: gainsboro;\")\n        widget_html     <- paste0(tags$li(class = 'new', id = widget_id, remove_btn, p('.', style = 'color: transparent'), text_area_tmpl))\n        \n        dataList        <- list(id = 'gridster_frame', html = widget_html)\n        session$sendCustomMessage(\"shinyGridster.add_widget\", dataList)\n      }\n    }\n  })\n\n  \n  #Save dashboard function\n  saveDashBoard <- function(dashboard_title){\n      isolate({     \n        #Initialize/populate dashboard state object\n        dashboard_state <- fromJSON(input$gridster_frame)\n        #print('====Raw Object====') print(dashboard_state)\n\n        #Save widgets\n        for (i in 1:length(dashboard_state)){\n          widget_id <- dashboard_state[[i]]$id\n          if(str_detect(widget_id, 'gItemPlot')){\n            chart_id                          <- str_replace(widget_id, 'w_','')\n            charteditor_id                    <- str_c(chart_id,'_editor')\n            dashboard_state[[i]]$db_name      <- input_dbs[[chart_id]]\n            dashboard_state[[i]]$query        <- input_queries[[chart_id]]\n            dashboard_state[[i]]$data         <- input_data[[chart_id]]\n            dashboard_state[[i]]$last_update  <- last_update[[chart_id]]\n            dashboard_state[[i]]$chart_type   <- input[[charteditor_id]]$chartType\n            dashboard_state[[i]]$chart_opts   <- input[[charteditor_id]]$options\n          }\n          else if(str_detect(widget_id, 'textArea')){\n            textarea_id     <- str_replace(widget_id, 'w_','')\n            dashboard_state[[i]]$content <-  input[[textarea_id]]\n            #print(str_c(textarea_id,' content: ', input[[textarea_id]]))\n          }\n          else{\n            print('Unknown widget')\n          }  \n        }\n        #Save dashboard state\n        save(list = c('dashboard_state'), file = str_c(getwd(), '/dashboards/', dashboard_title, '.RData'))\n        #print('====Saved Object===='); print(dashboard_state)\n      })\n    }\n  \n  #Save/Save As Observers\n  observe({  \n    if(input$save_as_dash_btn > 0) {\n      dashboard_title <- isolate(input$save_file_name)\n      saveDashBoard(dashboard_title)\n      new_available_dashboards  <- str_replace(list.files(str_c(getwd(),'/dashboards')), '.RData', '')\n      selected_dashboard        <- dashboard_title\n      updateSelectInput(session, 'sel_dashboard', choices = new_available_dashboards, selected = dashboard_title) \n    }\n  })\n  observe({\n    if(input$save_dash_btn > 0){\n      #print(selected_dashboard())\n      saveDashBoard(selected_dashboard())\n    }\n  })\n\n  \n  #Load dash observer\n  observe({\n        #Load data\n        load(file = str_c(getwd(), '/dashboards/', selected_dashboard(), '.RData'))\n        #print('====Loaded Object====')print(dashboard_state)\n        \n        #Load widgets\n        for (i in 1:length(dashboard_state)){\n          if(str_detect(dashboard_state[[i]]$id, 'gItemPlot')){\n            widget_counts$num_charts <- isolate(widget_counts$num_charts) + 1\n            num_charts      <- isolate(widget_counts$num_charts)\n            chart_id        <- str_c('gItemPlot', num_charts)\n            widget_id       <- str_c('w_', chart_id)\n            \n            chart_type                <- dashboard_state[[i]]$chart_type\n            chart_opts                <- dashboard_state[[i]]$chart_opts\n            input_dbs[[chart_id]]     <- dashboard_state[[i]]$db_name\n            input_queries[[chart_id]] <- dashboard_state[[i]]$query\n            input_data[[chart_id]]    <- dashboard_state[[i]]$data\n            last_update[[chart_id]]   <- dashboard_state[[i]]$last_update\n            widget_html               <- chartWidget(chart_id, chart_type, chart_opts)          \n          }\n          else if(str_detect(dashboard_state[[i]]$id, 'textArea')){\n            widget_counts$num_textareas <- isolate(widget_counts$num_textareas) + 1\n            num_textareas   <- isolate(widget_counts$num_textareas)\n            textarea_id     <- str_c('textArea', num_textareas)\n            widget_id       <- str_c('w_', textarea_id)\n            \n            widget_content  <- tags$div(id = textarea_id, class = \"shinytinymce\", HTML(dashboard_state[[i]]$content), style = \"resize: none; width: 100%; height: 78%; border-style: none; background: gainsboro;\")\n            widget_html     <- paste0(tags$li(class = 'new', id = widget_id, remove_btn, p('.', style = 'color: transparent'), widget_content))     \n          }\n          else{\n            print('Unknown widget')\n          }\n          \n          #Build parameter list for widget\n          dataList <- list(id = 'gridster_frame',\n                           col = dashboard_state[[i]]$row,\n                           row = dashboard_state[[i]]$col,\n                           size_x = dashboard_state[[i]]$size_x,\n                           size_y = dashboard_state[[i]]$size_y,\n                           html = widget_html)\n\n          #Add widget\n          session$sendCustomMessage(type = \"shinyGridster.add_widget\", dataList)\n          \n       }\n\n       #print(str_c('Loaded Charts: ', isolate(widget_counts$num_charts), ' Loaded Textareas: ', isolate(widget_counts$num_textareas)))\n\n  })\n  \n  #Render debugging outputs\n  output$last_update_list <- renderPrint({reactiveValuesToList(last_update)})\n  #output$active_chart_id <- renderText({input$active_chart_id})\n  #output$tinymce_test   <- renderText({input$dashboard_title_panel})\n  #output$gridster_state  <- renderPrint({fromJSON(input$gridster_frame)})\n  #output$gridster_test <- renderPrint({fromJSON(input$gridster_state)})\n  \n})\n\n\n\n",
    "created" : 1400787190212.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3819752172",
    "id" : "6861D475",
    "lastKnownWriteTime" : 1400787890,
    "path" : "~/Desktop/dev_software/ShinyDash/server.R",
    "project_path" : "server.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}